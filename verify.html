<!DOCTYPE html>
<html>
<head>
    <title>API Verification</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body style="background:#000; color:#fff; font-family:monospace;">
    <div id="status">INITIALIZING...</div>

    <script>
        // --- APNI FIREBASE CONFIG YAHAN DALEIN ---
        const firebaseConfig = {
            apiKey: "AIzaSyDRpY5f4_SPuuspfed3UkxG99gByr9rqH8",
            authDomain: "host-panel-fd943.firebaseapp.com",
            projectId: "host-panel-fd943",
            storageBucket: "host-panel-fd943.firebasestorage.app",
            messagingSenderId: "75573266168",
            appId: "1:75573266168:web:1db02b2665c4431e495d0d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // URL Params: ?key=MYKEY&admin=ADMINUID&hwid=DEVICEID
        const params = new URLSearchParams(window.location.search);
        const userKey = params.get('key');
        const adminId = params.get('admin');
        const hwid = params.get('hwid');

        async function check() {
            if(!userKey || !adminId || !hwid) {
                document.body.innerText = "INVALID_PARAMETERS";
                return;
            }

            try {
                const snap = await db.collection("keys")
                    .where("key", "==", userKey)
                    .where("rootAdminId", "==", adminId)
                    .get();

                if (snap.empty) {
                    document.body.innerText = "INVALID_KEY";
                    return;
                }

                const doc = snap.docs[0];
                const data = doc.data();

                // 1. Status Check
                if (data.status !== 'active') {
                    document.body.innerText = "KEY_BANNED";
                    return;
                }

                // 2. Expiry Check
                if (data.expiry.toDate() < new Date()) {
                    document.body.innerText = "KEY_EXPIRED";
                    return;
                }

                // 3. HWID / Device Limit Check
                let devices = data.devicesUsed || [];
                if (devices.includes(hwid)) {
                    document.body.innerText = "OK"; // Pehle se registered hai
                } else if (devices.length < data.limit) {
                    devices.push(hwid);
                    await db.collection("keys").doc(doc.id).update({ devicesUsed: devices });
                    document.body.innerText = "OK"; // Naya device register ho gaya
                } else {
                    document.body.innerText = "DEVICE_LIMIT_EXCEEDED";
                }

            } catch (e) {
                document.body.innerText = "SERVER_ERROR";
            }
        }
        check();
    </script>
</body>
</html>
