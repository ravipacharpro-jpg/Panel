<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIP PANEL PRO v9</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --blue: #00f3ff; --pink: #ff00ff; --green: #39ff14; --red: #ff4444; --bg: #050505; --card: #121212; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .header { background: #000; padding: 12px; border-bottom: 1px solid var(--blue); text-align: center; }
        .brand-name { font-size: 18px; font-weight: bold; color: var(--blue); text-shadow: 0 0 8px var(--blue); margin: 0; }
        .main { flex: 1; padding: 15px; overflow-y: auto; padding-bottom: 80px; width: 100%; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid #222; margin-bottom: 15px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: #111; padding: 10px; border-radius: 10px; text-align: center; border: 1px solid #222; }
        .stat-box h3 { font-size: 10px; color: #777; margin: 0; }
        .stat-box p { font-size: 16px; margin: 5px 0 0; font-weight: bold; color: var(--blue); }
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #000; border-top: 1px solid var(--blue); display: flex; justify-content: space-around; padding: 8px 0; z-index: 2000; }
        .nav-item { color: #555; text-align: center; cursor: pointer; flex: 1; display: flex; flex-direction: column; align-items: center; }
        .nav-item i { font-size: 18px; margin-bottom: 3px; }
        .nav-item span { font-size: 10px; }
        .nav-item.active { color: var(--blue); text-shadow: 0 0 10px var(--blue); }
        input, select { width: 100%; padding: 12px; margin: 8px 0; background: #000; border: 1px solid #333; color: white; border-radius: 8px; font-size: 14px; outline: none; }
        .btn { width: 100%; padding: 12px; background: transparent; border: 1px solid var(--blue); color: var(--blue); cursor: pointer; border-radius: 10px; font-weight: bold; font-size: 13px; text-transform: uppercase; margin-top: 5px; }
        .table-container { overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; min-width: 500px; }
        th { text-align: left; color: #555; padding: 8px; border-bottom: 1px solid #333; }
        td { padding: 10px 8px; border-bottom: 1px solid #1a1a1a; }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .hidden { display: none !important; }
        .action-btn { background: none; border: 1px solid #444; color: white; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px; }
        .usage-green { color: var(--green); }
        .usage-red { color: var(--red); font-weight: bold; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="card" style="width: 100%; max-width: 320px; text-align: center;">
            <h2 style="color: var(--blue);">VIP LOGIN</h2>
            <input type="text" id="log-user" placeholder="Username">
            <input type="password" id="log-pass" placeholder="Password">
            <button class="btn" onclick="app.login()">Login</button>
        </div>
    </div>

    <div class="header"><div id="disp-brand-top" class="brand-name">VIP PANEL</div></div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="app.tab('dash', this)"><i class="fas fa-home"></i><span>Home</span></div>
        <div class="nav-item" onclick="app.tab('keys', this)"><i class="fas fa-key"></i><span>Keys</span></div>
        <div class="nav-item owner-admin-only hidden" onclick="app.tab('staff', this)"><i class="fas fa-users"></i><span>Staff</span></div>
        <div class="nav-item" onclick="app.tab('settings', this)"><i class="fas fa-sliders-h"></i><span>Setup</span></div>
        <div class="nav-item" onclick="app.logout()" style="color:red;"><i class="fas fa-power-off"></i><span>Exit</span></div>
    </div>

    <div class="main">
        <div id="tab-dash">
            <h2 style="margin:0;">Hi, <span id="disp-user" style="color: var(--pink);">...</span></h2>
            <div class="stats-grid">
                <div class="stat-box"><h3>Balance</h3><p id="disp-bal">0</p></div>
                <div class="stat-box"><h3>Role</h3><p id="disp-role">-</p></div>
            </div>
        </div>

        <!-- Keys Tab for Everyone (Owner, Admin, Reseller) -->
        <div id="tab-keys" class="hidden">
            <div class="card">
                <h3 style="margin-top:0; color:var(--blue)">Generate Key</h3>
                <input type="text" id="key-name" placeholder="Exact Name (Ex: RAVI)">
                <input type="number" id="key-limit" value="1" placeholder="Device Limit">
                <select id="key-time" onchange="app.checkPrice()">
                    <option value="5h">5 Hours</option>
                    <option value="1d">1 Day</option>
                    <option value="7d">7 Days</option>
                    <option value="14d">14 Days</option>
                    <option value="30d">30 Days</option>
                    <option value="LIFETIME">Lifetime</option>
                </select>
                <div id="price-display" style="font-size: 11px; color: var(--pink); margin-bottom: 5px;">Cost: 0 Balance</div>
                <button class="btn" onclick="app.generateKey()">Create & Copy Key</button>
            </div>
            
            <div class="card">
                <h3 style="font-size: 14px;">My Key List & Device Status</h3>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Name/Key</th><th>Device Login</th><th>Duration</th><th>Action</th></tr></thead>
                        <tbody id="key-list"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-staff" class="hidden">
            <div class="card"><h3>Create Staff</h3><input type="text" id="new-user" placeholder="Username"><input type="password" id="new-pass" placeholder="Password"><select id="new-role"></select><button class="btn" onclick="app.createStaff()">Create</button></div>
            <div class="card">
                <h3 id="manage-title" style="color:var(--pink)">Account Management</h3>
                <div class="table-container"><table><thead><tr><th>Username</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead><tbody id="manage-staff-list"></tbody></table></div>
            </div>
        </div>

        <div id="tab-settings" class="hidden">
            <div class="card owner-only hidden"><h3>Price Manager</h3><div class="table-container"><table><tr><td>5 Hours</td><td><input type="number" id="p-5h" style="width:70px"></td></tr><tr><td>1 Day</td><td><input type="number" id="p-1d" style="width:70px"></td></tr><tr><td>30 Day</td><td><input type="number" id="p-30d" style="width:70px"></td></tr></table></div><button class="btn" onclick="app.savePricing()">Update Prices</button></div>
            <div class="card"><h3>Settings</h3><input type="text" id="set-brand" placeholder="Brand Name"><button class="btn" onclick="app.saveBrand()">Save Brand</button></div>
        </div>
    </div>

    <a href="#" id="tg-support" class="tg-btn" target="_blank"><i class="fab fa-telegram-plane"></i></a>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // --- YOUR CONFIG (Don't Change) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDRpY5f4_SPuuspfed3UkxG99gByr9rqH8",
            authDomain: "host-panel-fd943.firebaseapp.com",
            projectId: "host-panel-fd943",
            storageBucket: "host-panel-fd943.firebasestorage.app",
            messagingSenderId: "75573266168",
            appId: "1:75573266168:web:1db02b2665c4431e495d0d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const app = {
            user: null, userData: null, pricing: {},
            login: function() {
                const u = document.getElementById('log-user').value.trim();
                const p = document.getElementById('log-pass').value.trim();
                auth.signInWithEmailAndPassword(u + "@panel.com", p).catch(e => alert(e.message));
            },
            logout: function() { auth.signOut().then(() => location.reload()); },
            tab: function(t, el) {
                ['dash','keys','staff','settings'].forEach(id => document.getElementById('tab-'+id).classList.add('hidden'));
                document.getElementById('tab-'+t).classList.remove('hidden');
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                el.classList.add('active');
            },

            copy: function(txt) { navigator.clipboard.writeText(txt); alert("Key Copied!"); },

            checkPrice: function() {
                const time = document.getElementById('key-time').value;
                const cost = this.pricing[time] || 0;
                document.getElementById('price-display').innerText = "Cost: " + cost + " Balance";
            },

            generateKey: async function() {
                const name = document.getElementById('key-name').value.trim();
                const limit = document.getElementById('key-limit').value;
                const time = document.getElementById('key-time').value;
                const cost = this.pricing[time] || 0;
                if(this.userData.role !== 'owner' && this.userData.balance < cost) return alert("Low Balance!");
                if(!name) return alert("Enter Name");

                await db.collection("keys").add({
                    key: name, customer: name, limit: parseInt(limit),
                    devicesUsed: [], // Array to track HWIDs
                    duration: time, adminId: this.user.uid, adminName: this.userData.username,
                    status: "active", createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                if(this.userData.role !== 'owner') {
                    await db.collection("users").doc(this.user.uid).update({ balance: firebase.firestore.FieldValue.increment(-cost) });
                }
                this.copy(name);
            },

            resetHwid: function(id) {
                if(confirm("Reset Device Limit for this key?")) {
                    db.collection("keys").doc(id).update({ devicesUsed: [] }).then(() => alert("HWID Reset Success!"));
                }
            },

            createStaff: async function() {
                const u = document.getElementById('new-user').value.trim();
                const p = document.getElementById('new-pass').value.trim();
                const r = document.getElementById('new-role').value;
                try {
                    const secApp = firebase.initializeApp(firebaseConfig, "Sec");
                    const cred = await firebase.auth(secApp).createUserWithEmailAndPassword(u + "@panel.com", p);
                    await db.collection("users").doc(cred.user.uid).set({ username: u, role: r, balance: 0, status: "active", createdBy: this.user.uid });
                    await firebase.auth(secApp).signOut(); await secApp.delete();
                    alert("Staff Created!");
                } catch(e) { alert(e.message); }
            },

            toggleStatus: function(uid, currentStatus) {
                const newStatus = currentStatus === 'active' ? 'banned' : 'active';
                db.collection("users").doc(uid).update({ status: newStatus });
            },

            savePricing: function() {
                const p = { "5h": parseInt(document.getElementById('p-5h').value), "1d": parseInt(document.getElementById('p-1d').value), "30d": parseInt(document.getElementById('p-30d').value) };
                db.collection("settings").doc("pricing").set(p).then(() => alert("Prices Updated!"));
            },

            saveBrand: function() {
                db.collection("users").doc(this.user.uid).update({ brandName: document.getElementById('set-brand').value }).then(() => alert("Saved!"));
            }
        };

        auth.onAuthStateChanged(async (u) => {
            if (u) {
                const doc = await db.collection("users").doc(u.uid).get();
                if(doc.exists) {
                    app.user = u; app.userData = doc.data();
                    if(app.userData.status === 'banned') { alert("Banned!"); auth.signOut(); return; }

                    document.getElementById('login-overlay').style.display = 'none';
                    document.getElementById('disp-user').innerText = app.userData.username;
                    document.getElementById('disp-role').innerText = app.userData.role.toUpperCase();
                    document.getElementById('disp-bal').innerText = app.userData.role === 'owner' ? "âˆž" : app.userData.balance;
                    document.getElementById('disp-brand-top').innerText = app.userData.brandName || "VIP PANEL";

                    const rs = document.getElementById('new-role');
                    if(app.userData.role === 'admin') rs.innerHTML = '<option value="reseller">Reseller</option>';
                    else rs.innerHTML = '<option value="admin">Admin</option><option value="reseller">Reseller</option>';

                    if(app.userData.role === 'owner' || app.userData.role === 'admin') document.querySelectorAll('.owner-admin-only').forEach(e => e.classList.remove('hidden'));
                    if(app.userData.role === 'owner') document.querySelectorAll('.owner-only').forEach(e => e.classList.remove('hidden'));

                    db.collection("settings").doc("pricing").onSnapshot(s => { if(s.exists) { app.pricing = s.data(); app.checkPrice(); } });

                    // Key List (For Owner, Admin, AND Reseller)
                    db.collection("keys").where("adminId", "==", u.uid).orderBy("createdAt", "desc").onSnapshot(snap => {
                        const list = document.getElementById('key-list'); list.innerHTML = "";
                        snap.forEach(d => {
                            const k = d.data();
                            const usedCount = k.devicesUsed ? k.devicesUsed.length : 0;
                            const usageClass = usedCount >= k.limit ? 'usage-red' : 'usage-green';
                            
                            list.innerHTML += `<tr>
                                <td>${k.key}</td>
                                <td class="${usageClass}">${usedCount} / ${k.limit}</td>
                                <td>${k.duration}</td>
                                <td>
                                    <button class="action-btn" onclick="app.copy('${k.key}')"><i class="fas fa-copy"></i></button>
                                    <button class="action-btn" onclick="app.resetHwid('${d.id}')" title="Reset HWID"><i class="fas fa-sync-alt"></i></button>
                                    <button class="action-btn" onclick="db.collection('keys').doc('${d.id}').delete()" style="color:red"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>`;
                        });
                    });

                    // Management Table
                    let staffQuery;
                    if(app.userData.role === 'owner') staffQuery = db.collection("users");
                    else staffQuery = db.collection("users").where("createdBy", "==", u.uid);

                    staffQuery.onSnapshot(snap => {
                        const list = document.getElementById('manage-staff-list'); list.innerHTML = "";
                        snap.forEach(d => {
                            const s = d.data();
                            if(d.id !== u.uid) {
                                list.innerHTML += `<tr><td>${s.username}</td><td>${s.role.toUpperCase()}</td><td class="status-${s.status}">${s.status.toUpperCase()}</td><td>
                                    <button class="action-btn" onclick="db.collection('users').doc('${d.id}').update({balance:firebase.firestore.FieldValue.increment(parseInt(prompt('Add Balance?')))})">ðŸ’°</button>
                                    <button class="action-btn" style="color:${s.status=='active'?'red':'green'}" onclick="app.toggleStatus('${d.id}','${s.status}')">${s.status=='active'?'BAN':'UNBAN'}</button>
                                </td></tr>`;
                            }
                        });
                    });
                }
            }
        });
    </script>
</body>
</html>
